<!DOCTYPE html>
<html>
<head>
  <title>VNC Diagnostic</title>
  <style>
    body { margin: 0; background: #000; color: #0f0; font-family: monospace; font-size: 13px; }
    #log { padding: 10px; max-height: 200px; overflow-y: auto; border-bottom: 1px solid #0f0; }
    #log div { margin: 2px 0; }
    .ok { color: #0f0; } .err { color: #f55; } .warn { color: #fa0; } .info { color: #0ff; }
    #vnc-container { width: 100%; height: calc(100vh - 220px); }
  </style>
</head>
<body>
  <div id="log"></div>
  <div id="vnc-container"></div>

  <script type="module">
    const logEl = document.getElementById('log');
    function log(msg, cls = 'info') {
      const d = document.createElement('div');
      d.className = cls;
      d.textContent = new Date().toISOString().slice(11, 23) + ' ' + msg;
      logEl.appendChild(d);
      logEl.scrollTop = logEl.scrollHeight;
      console.log('[VNC-DIAG]', msg);
    }

    log('Starting VNC diagnostic...');
    log('Target: ws://192.168.1.37:6080');
    log('Credentials: username=agent_smith, password=137009');

    try {
      const mod = await import('@novnc/novnc/lib/rfb.js');
      log('Module keys: ' + Object.keys(mod).join(', '));

      // Try different ways to get the constructor
      const RFB = mod.default || mod.RFB || mod;
      log('RFB type: ' + typeof RFB + ', isFunction: ' + (typeof RFB === 'function'));

      if (typeof RFB !== 'function') {
        log('RFB is not a function! Checking nested...', 'err');
        log('mod.default type: ' + typeof mod.default);
        if (mod.default && typeof mod.default === 'object') {
          log('mod.default keys: ' + Object.keys(mod.default).join(', '));
          if (mod.default.default) {
            log('Trying mod.default.default...', 'warn');
            const RFB2 = mod.default.default;
            if (typeof RFB2 === 'function') {
              log('Found RFB at mod.default.default!', 'ok');
              startVNC(RFB2);
              throw new Error('stop');
            }
          }
        }
        log('Could not find RFB constructor. Falling back to WS test.', 'err');
        testWebSocket();
      } else {
        startVNC(RFB);
      }
    } catch (err) {
      if (err.message !== 'stop') {
        log('FATAL ERROR: ' + err.message, 'err');
        log(err.stack, 'err');
      }
    }

    function startVNC(RFB) {
      log('Creating RFB instance...', 'info');
      const container = document.getElementById('vnc-container');

      const rfb = new RFB(container, 'ws://192.168.1.37:6080/', {
        credentials: { username: 'agent_smith', password: '137009' },
        wsProtocols: ['binary'],
      });

      rfb.scaleViewport = true;
      rfb.resizeSession = false;
      rfb.qualityLevel = 6;
      rfb.compressionLevel = 2;

      rfb.addEventListener('connect', () => {
        log('VNC CONNECTED! Desktop should be visible below.', 'ok');
      });
      rfb.addEventListener('disconnect', (e) => {
        log('VNC DISCONNECTED: clean=' + e.detail?.clean, e.detail?.clean ? 'warn' : 'err');
      });
      rfb.addEventListener('securityfailure', (e) => {
        log('AUTH FAILED: ' + (e.detail?.reason || 'unknown reason'), 'err');
        log('Status: ' + e.detail?.status, 'err');
      });
      rfb.addEventListener('credentialsrequired', (e) => {
        log('CREDENTIALS REQUIRED: types=' + JSON.stringify(e.detail?.types), 'warn');
        rfb.sendCredentials({ username: 'agent_smith', password: '137009' });
        log('Sent credentials via sendCredentials()', 'info');
      });
      rfb.addEventListener('desktopname', (e) => {
        log('Desktop name: ' + e.detail?.name, 'ok');
      });

      log('RFB instance created. Waiting for VNC events...', 'info');
    }

    function testWebSocket() {
      log('Testing raw WebSocket to ws://192.168.1.37:6080 ...', 'warn');
      const ws = new WebSocket('ws://192.168.1.37:6080/', ['binary']);
      ws.binaryType = 'arraybuffer';
      ws.onopen = () => log('WebSocket CONNECTED', 'ok');
      ws.onmessage = (e) => {
        const buf = new Uint8Array(e.data);
        const str = new TextDecoder().decode(buf.slice(0, Math.min(buf.length, 50)));
        log('WS data (' + buf.length + ' bytes): ' + JSON.stringify(str));
      };
      ws.onerror = () => log('WebSocket ERROR', 'err');
      ws.onclose = (e) => log('WebSocket CLOSED: code=' + e.code + ' clean=' + e.wasClean, 'warn');
    }
  </script>
</body>
</html>
